{% extends "base.html" %}
{% load static %}

{% block content %}
<h2 class="mb-3">Nova Venda</h2>

<form method="post" id="venda-form">
    {% csrf_token %}

    <div class="row mb-3">
        <div class="col-4">
            {{ form.data_venda.label_tag }}
            {{ form.data_venda }}
        </div>
        <div class="col-6">
            {{ form.cliente.label_tag }}
            {{ form.cliente }}
        </div>
    </div>

    <h4 class="mt-4">Itens da Venda</h4>

    {{ formset.management_form }}

    <table class="table table-bordered" id="itens-table">
        <thead class="table-light">
            <tr>
                <th>Produto</th>
                <th>Qtd</th>
                <th>Subtotal</th>
                <th>Ações</th>
            </tr>
        </thead>

        <tbody>
        {% for f in formset.forms %}
            <tr class="item-row">

                {{ f.id }}

                <td>
                    <select 
                        name="itens-{{ forloop.counter0 }}-produto"
                        class="form-control produto-select">
                        {% for p in produto_list %}
                            <option value="{{ p.id }}"
                                data-preco="{{ p.preco_venda }}"
                                {% if f.instance.produto and f.instance.produto.id == p.id %}selected{% endif %}>
                                {{ p.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </td>

                <td>
                    <input type="number"
                           name="itens-{{ forloop.counter0 }}-quantidade"
                           class="form-control quantidade-input"
                           value="{{ f.instance.quantidade|default:1 }}"
                           min="1">
                </td>

                <td class="subtotal-cell">0,00</td>

                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-item">-</button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <button type="button" class="btn btn-secondary my-2" id="add-item">
        + Adicionar Item
    </button>

    <div class="mb-3">
        <label><strong>Total da Venda:</strong></label>
        <input type="text" id="total_venda" class="form-control" value="0,00" readonly>
    </div>

    <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-success">Realizar Venda</button>
        <a href="/vendas/" class="btn btn-secondary">Cancelar</a>
    </div>

<table style="display:none">
    <tbody id="empty-form">
        <tr class="item-row">
            {{ formset.empty_form.id }}

            <td>
                <select name="itens-__PREFIX__-produto"
                        class="form-control produto-select">
                    {% for p in produto_list %}
                        <option value="{{ p.id }}" data-preco="{{ p.preco_venda }}">
                            {{ p.nome }}
                        </option>
                    {% endfor %}
                </select>
            </td>

            <td>
                <input type="number"
                       name="itens-__PREFIX__-quantidade"
                       class="form-control quantidade-input"
                       value="1"
                       min="1">
            </td>

            <td class="subtotal-cell">0,00</td>

            <td>
                <button type="button" class="btn btn-danger btn-sm remove-item">-</button>
            </td>
        </tr>
    </tbody>
</table>

<script>
function formatBR(v){
    let n = Number(v);
    if(isNaN(n)) n = 0;
    return n.toFixed(2).replace('.', ',');
}

function recalcTotals(){
    let total = 0;

    document.querySelectorAll("#itens-table .item-row").forEach(row => {
        let select = row.querySelector(".produto-select");
        let qtdInput = row.querySelector(".quantidade-input");

        let preco = parseFloat(
            select.options[select.selectedIndex].dataset.preco
        );

        let qtd = parseInt(qtdInput.value) || 0;

        let subtotal = preco * qtd;
        row.querySelector(".subtotal-cell").innerText = formatBR(subtotal);

        total += subtotal;
    });

    document.getElementById("total_venda").value = formatBR(total);
}

function bindRowEvents(row){
    row.querySelector(".produto-select")
        .addEventListener("change", recalcTotals);

    row.querySelector(".quantidade-input")
        .addEventListener("input", recalcTotals);

    row.querySelector(".remove-item")
        .addEventListener("click", function(){
            row.remove();
            updateTotalForms(-1);
            recalcTotals();
        });
}

function updateTotalForms(delta){
    const totalForms = document.querySelector('input[name="itens-TOTAL_FORMS"]');
    totalForms.value = parseInt(totalForms.value) + delta;
}

document.getElementById("add-item")
    .addEventListener("click", function(){

        const totalForms = document.querySelector('input[name="itens-TOTAL_FORMS"]');
        const idx = parseInt(totalForms.value);

        const empty = document.querySelector("#empty-form tr").cloneNode(true);

        empty.innerHTML = empty.innerHTML.replace(/__PREFIX__/g, idx);

        document.querySelector("#itens-table tbody").appendChild(empty);
        updateTotalForms(1);

        bindRowEvents(empty);
        recalcTotals();
    });

document.querySelectorAll("#itens-table .item-row")
    .forEach(row => bindRowEvents(row));

document.addEventListener("DOMContentLoaded", recalcTotals);
</script>

{% endblock %}
